<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Message History :: Red Hat build of Apache Camel</title>
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">Red Hat build of Apache Camel</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="components" data-version="4.0.x">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">Camel Components</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="enterprise-integration-patterns.html">Enterprise Integration Patterns</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="aggregate-eip.html">Aggregate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="bean-eip.html">Bean</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="change-data-capture.html">Change Data Capture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="channel-adapter.html">Channel Adapter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="choice-eip.html">Content Based Router</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="circuitBreaker-eip.html">Circuit Breaker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="claimCheck-eip.html">Claim Check</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="competing-consumers.html">Competing Consumers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="composed-message-processor.html">Composed Message Processor</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="content-enricher.html">Content Enricher</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="content-filter-eip.html">Content Filter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="convertBodyTo-eip.html">Convert Body To</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="correlation-identifier.html">Correlation Identifier</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="dead-letter-channel.html">Dead Letter Channel</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="delay-eip.html">Delay</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="durable-subscriber.html">Durable Subscriber</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="dynamicRouter-eip.html">Dynamic Router</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="enrich-eip.html">Enrich</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="eventDrivenConsumer-eip.html">Event Driven Consumer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="event-message.html">Event Message</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="filter-eip.html">Filter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="from-eip.html">From</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="guaranteed-delivery.html">Guaranteed Delivery</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="idempotentConsumer-eip.html">Idempotent Consumer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="intercept.html">Intercept</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kamelet-eip.html">Kamelet</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="loadBalance-eip.html">Load Balance</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="log-eip.html">Log</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="loop-eip.html">Loop</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="marshal-eip.html">Marshal</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="message.html">Message</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="message-broker.html">Message Broker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="message-bus.html">Message Bus</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="message-channel.html">Message Channel</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="message-dispatcher.html">Message Dispatcher</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="message-endpoint.html">Message Endpoint</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="message-expiration.html">Message Expiration</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="message-history.html">Message History</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="message-router.html">Message Router</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="message-translator.html">Message Translator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="messaging-bridge.html">Messaging Bridge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="messaging-gateway.html">Messaging Gateway</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="messaging-mapper.html">Messaging Mapper</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="multicast-eip.html">Multicast</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="normalizer.html">Normalizer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pipeline-eip.html">Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="point-to-point-channel.html">Point to Point Channel</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pollEnrich-eip.html">Poll Enrich</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="polling-consumer.html">Polling Consumer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="process-eip.html">Process</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="process-manager.html">Process Manager</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="publish-subscribe-channel.html">Publish Subscribe Channel</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="recipientList-eip.html">Recipient List</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="removeHeader-eip.html">Remove Header</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="removeHeaders-eip.html">Remove Headers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="removeProperties-eip.html">Remove Properties</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="removeProperty-eip.html">Remove Property</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="requestReply-eip.html">Request Reply</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="resequence-eip.html">Resequence</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="resilience4j-eip.html">Resilience4j Circuit Breaker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="return-address.html">Return Address</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="rollback-eip.html">Rollback</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="routingSlip-eip.html">Routing Slip</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="saga-eip.html">Saga</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="sample-eip.html">Sample</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="scatter-gather.html">Scatter Gather</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="script-eip.html">Script</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="selective-consumer.html">Selective Consumer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="service-activator.html">Service Activator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="serviceCall-eip.html">Service Call</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setBody-eip.html">Set Body</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setHeader-eip.html">Set Header</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setProperty-eip.html">Set Property</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="sort-eip.html">Sort</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="split-eip.html">Split</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="step-eip.html">Step</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stop-eip.html">Stop</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="threads-eip.html">Threads</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="throttle-eip.html">Throttle</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="to-eip.html">To</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="toD-eip.html">To Dynamic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="transactional-client.html">Transactional Client</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="transform-eip.html">Transform</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="unmarshal-eip.html">Unmarshal</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="validate-eip.html">Validate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="wireTap-eip.html">Wire Tap</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Camel Components</span>
    <span class="version">4.0.x</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="../../4.10.x/index.html">Camel Components</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../4.10.x/index.html">4.10.x (LTS)</a>
        </li>
        <li class="version">
          <a href="../../4.8.x/index.html">4.8.x</a>
        </li>
        <li class="version">
          <a href="../../4.4.x/index.html">4.4.x</a>
        </li>
        <li class="version is-current">
          <a href="../index.html">4.0.x</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../manual/4.10.x/index.html">User manual</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../manual/4.10.x/index.html">4.10.x</a>
        </li>
        <li class="version">
          <a href="../../../manual/4.8.x/index.html">4.8.x</a>
        </li>
        <li class="version">
          <a href="../../../manual/4.4.x/index.html">4.4.x</a>
        </li>
        <li class="version">
          <a href="../../../manual/4.0.x/index.html">4.0.x</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../manual/4.10.x/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Camel Components</a></li>
    <li><a href="enterprise-integration-patterns.html">Enterprise Integration Patterns</a></li>
    <li><a href="message-history.html">Message History</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">4.0.x</button>
  <div class="version-menu">
    <a class="version" href="../../4.10.x/eips/message-history.html">4.10.x (LTS)</a>
    <a class="version" href="../../4.8.x/eips/message-history.html">4.8.x</a>
    <a class="version" href="../../4.4.x/eips/message-history.html">4.4.x</a>
    <a class="version is-current" href="message-history.html">4.0.x</a>
  </div>
</div>
<div class="edit-this-page"><a href="https://github.com/rhaetor/rh-camel-jboss/edit/camel-4.0.0-branch/core/camel-core-engine/src/main/docs/modules/eips/pages/message-history.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Message History</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Camel supports the
<a href="https://www.enterpriseintegrationpatterns.com/patterns/messaging/MessageHistory.html">Message History</a>
from the <a href="enterprise-integration-patterns.html" class="xref page">EIP patterns</a> book.</p>
</div>
<div class="paragraph">
<p>The Message History from the EIP patterns allows for analyzing and debugging the flow of messages in a loosely coupled system.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/eip/MessageHistory.gif" alt="image">
</div>
</div>
<div class="paragraph">
<p>Attaching a Message History to the message will provide a list of all applications that the message passed through since its origination.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enabling_message_history"><a class="anchor" href="#_enabling_message_history"></a>Enabling Message History</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The message history is disabled by default (to optimize for lower footprint out of the box). You should only enable message history
if needed, such as during development, where Camel can report route stack-traces when a message failed with an exception.
But for production usage, then message history should only be enabled if you have monitoring systems that rely on gathering these
fine-grained details. When message history is enabled then there is a slight performance overhead as the history data is stored
in a <code>java.util.concurrent.CopyOnWriteArrayList</code> due to the need of being thread safe.</p>
</div>
<div class="paragraph">
<p>The Message History can be enabled or disabled per CamelContext or per route (disabled by default).
For example, you can turn it on with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">camelContext.setMessageHistory(true);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or in XML</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;camelContext messageHistory="true"&gt;

&lt;/camelContext&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or when using Spring Boot or Quarkus, you can enable this in the configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">camel.springboot.message-history = true</code></pre>
</div>
</div>
<div class="paragraph">
<p>And in Quarkus:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">camel.quarkus.message-history = true</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_route_level_message_history"><a class="anchor" href="#_route_level_message_history"></a>Route level Message History</h3>
<div class="paragraph">
<p>You can also enable or disable message history per route.
When doing this then Camel can only gather message history in the routes where this is enabled,
which means you may not have full coverage. You may still want to do this, for example to capture
the history in a critical route to help pin-point where the route is slow.</p>
</div>
<div class="paragraph">
<p>A route level configuration overrides the global configuration.</p>
</div>
<div class="paragraph">
<p>To enable in Java:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">from("jms:cheese")
  .messageHistory()
  .to("bean:validate")
  .to("bean:transform")
  .to("jms:wine");</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also turn off message history per route:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">from("jms:cheese")
  .messageHistory(false)
  .to("bean:validate")
  .to("bean:transform")
  .to("jms:wine");</code></pre>
</div>
</div>
<div class="paragraph">
<p>And in XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;route messageHistory="true"&gt;
  &lt;from uri="jms:cheese"/&gt;
  &lt;to uri="bean:validate"/&gt;
  &lt;to uri="bean:transform"/&gt;
  &lt;to uri="jms:wine"/&gt;
&lt;/route&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_enabling_source_location_information"><a class="anchor" href="#_enabling_source_location_information"></a>Enabling source location information</h3>
<div class="paragraph">
<p>Camel is capable of gathering precise source file:line-number for each EIPs in the routes.
When enabled, then the message history will output this information in the route stack-trace.</p>
</div>
<div class="paragraph">
<p>To enable source location:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">camelContext.setSourceLocationEnabled(true);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or in XML</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;camelContext sourceLocationEnabled="true"&gt;

&lt;/camelContext&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or when using Spring Boot or Quarkus, you can enable this in the configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">camel.springboot.source-location-enabled = true</code></pre>
</div>
</div>
<div class="paragraph">
<p>And in Quarkus:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">camel.quarkus.source-location-enabled = true</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_route_stack_trace_in_exceptions_logged_by_error_handler"><a class="anchor" href="#_route_stack_trace_in_exceptions_logged_by_error_handler"></a>Route stack-trace in exceptions logged by error handler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If Message History is enabled, then Camel will include this information,
when the <a href="../../../manual/4.10.x/error-handler.html" class="xref page">Error Handler</a> logs exhausted exceptions,
where you can see the message history; you may think this as a "route stacktrace".</p>
</div>
<div class="paragraph">
<p>And example is provided below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">2022-01-06 12:13:06.721 ERROR 67729 --- [ - timer://java] o.a.c.p.e.DefaultErrorHandler            : Failed delivery for (MessageId: B4365D4CED3E5E1-0000000000000004 on ExchangeId: B4365D4CED3E5E1-0000000000000004). Exhausted after delivery attempt: 1 caught: java.lang.IllegalArgumentException: The number is too low

Message History (source location is disabled)
---------------------------------------------------------------------------------------------------------------------------------------
Source                                   ID                             Processor                                          Elapsed (ms)
                                         route1/route1                  from[timer://java?period=2s]                                  2
                                         route1/setBody1                setBody[bean[MyJavaRouteBuilder method:randomNumbe            0
                                         route1/log1                    log                                                           1
                                         route1/filter1                 filter[simple{${body} &lt; 30}]                                  0
                                         route1/throwException1         throwException[java.lang.IllegalArgumentException]            0

Stacktrace
---------------------------------------------------------------------------------------------------------------------------------------

java.lang.IllegalArgumentException: The number is too low
	at sample.camel.MyJavaRouteBuilder.configure(MyJavaRouteBuilder.java:34) ~[classes/:na]
	at org.apache.camel.builder.RouteBuilder.checkInitialized(RouteBuilder.java:607) ~[camel-core-model-3.20.0.jar:3.20.0]
	at org.apache.camel.builder.RouteBuilder.configureRoutes(RouteBuilder.java:553) ~[camel-core-model-3.20.0.jar:3.20.0]</code></pre>
</div>
</div>
<div class="paragraph">
<p>When Message History is enabled then the full history is logged as shown above. Here we can see the full path
the message has been routed.</p>
</div>
<div class="paragraph">
<p>When Message History is disabled (by default) then the error handler logs a brief history with the last node
where the exception occurred as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">2022-01-06 12:12:32.072 ERROR 67704 --- [ - timer://java] o.a.c.p.e.DefaultErrorHandler            : Failed delivery for (MessageId: CD6D1B185A3706F-0000000000000004 on ExchangeId: CD6D1B185A3706F-0000000000000004). Exhausted after delivery attempt: 1 caught: java.lang.IllegalArgumentException: The number is too low

Message History (source location and message history is disabled)
---------------------------------------------------------------------------------------------------------------------------------------
Source                                   ID                             Processor                                          Elapsed (ms)
                                         route1/route1                  from[timer://java?period=2s]                                  2
	...
                                         route1/throwException1         throwException[java.lang.IllegalArgumentException]            0

Stacktrace
---------------------------------------------------------------------------------------------------------------------------------------

java.lang.IllegalArgumentException: The number is too low
	at sample.camel.MyJavaRouteBuilder.configure(MyJavaRouteBuilder.java:34) ~[classes/:na]
	at org.apache.camel.builder.RouteBuilder.checkInitialized(RouteBuilder.java:607) ~[camel-core-model-3.20.0.jar:3.20.0]
	at org.apache.camel.builder.RouteBuilder.configureRoutes(RouteBuilder.java:553) ~[camel-core-model-3.20.0.jar:3.20.0]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here you can see the Message History only outputs the input (route1) and the last step
where the exception occurred (throwException1).</p>
</div>
<div class="paragraph">
<p>Notice that the source column is empty, because source location is not enabled.
When enabled then, you can see exactly which source file and line number the message routed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">2022-01-06 12:19:01.277 ERROR 67870 --- [ - timer://java] o.a.c.p.e.DefaultErrorHandler            : Failed delivery for (MessageId: 37412D6F722F679-0000000000000003 on ExchangeId: 37412D6F722F679-0000000000000003). Exhausted after delivery attempt: 1 caught: java.lang.IllegalArgumentException: The number is too low

Message History
---------------------------------------------------------------------------------------------------------------------------------------
Source                                   ID                             Processor                                          Elapsed (ms)
MyJavaRouteBuilder:29                    route1/route1                  from[timer://java?period=2s]                                 10
MyJavaRouteBuilder:32                    route1/setBody1                setBody[bean[MyJavaRouteBuilder method:randomNumbe            1
MyJavaRouteBuilder:33                    route1/log1                    log                                                           1
MyJavaRouteBuilder:34                    route1/filter1                 filter[simple{${body} &lt; 30}]                                  0
MyJavaRouteBuilder:35                    route1/throwException1         throwException[java.lang.IllegalArgumentException]            0

Stacktrace
---------------------------------------------------------------------------------------------------------------------------------------

java.lang.IllegalArgumentException: The number is too low
	at sample.camel.MyJavaRouteBuilder.configure(MyJavaRouteBuilder.java:34) ~[classes/:na]
	at org.apache.camel.builder.RouteBuilder.checkInitialized(RouteBuilder.java:607) ~[camel-core-model-3.20.0.jar:3.20.0]
	at org.apache.camel.builder.RouteBuilder.configureRoutes(RouteBuilder.java:553) ~[camel-core-model-3.20.0.jar:3.20.0]</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case we can see its the <code>MyJavaRouteBuilder</code> class on line 35 that is the problem.</p>
</div>
<div class="sect2">
<h3 id="_configuring_route_stack_trace_from_error_handler"><a class="anchor" href="#_configuring_route_stack_trace_from_error_handler"></a>Configuring route stack-trace from error handler</h3>
<div class="paragraph">
<p>You can turn off logging Message History with <code>logExhaustedMessageHistory</code>
from the <a href="../../../manual/4.10.x/error-handler.html" class="xref page">Error Handler</a> using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">errorHandler(defaultErrorHandler().logExhaustedMessageHistory(false));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="../../../manual/4.10.x/error-handler.html" class="xref page">Error Handler</a> does not log the
message body/header details (to avoid logging sensitive message body details).
You can enable this with <code>logExhaustedMessageBody</code> on the error handler as shown:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">errorHandler(defaultErrorHandler().logExhaustedMessageBody(true));</code></pre>
</div>
</div>
<div class="paragraph">
<p>In XML configuring this is a bit different, as you configure this in the <code>redeliveryPolicy</code>
of the <code>&lt;errorHandler&gt;</code> as shown:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;camelContext messageHistory="true" errorHandlerRef="myErrorHandler" xmlns="http://camel.apache.org/schema/spring"&gt;

    &lt;errorHandler id="myErrorHandler"&gt;
      &lt;redeliveryPolicy logExhaustedMessageHistory="false" logExhaustedMessageBody="true"/&gt;
    &lt;/errorHandler&gt;

    &lt;route&gt;
      &lt;from uri="jms:cheese"/&gt;
      &lt;to uri="bean:validate"/&gt;
      &lt;to uri="bean:transform"/&gt;
      &lt;to uri="jms:wine"/&gt;
    &lt;/route&gt;
&lt;/camelContext&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_messagehistory_api"><a class="anchor" href="#_messagehistory_api"></a>MessageHistory API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When message history is enabled during routing Camel captures how the <code>Exchange</code> is routed,
as an <code>org.apache.camel.MessageHistory</code> entity that is stored on the <code>Exchange</code>.</p>
</div>
<div class="paragraph">
<p>On the <code>org.apache.camel.MessageHistory</code> there is information about the
route id, processor id, timestamp, and elapsed time it took to process the <code>Exchange</code> by the processor.</p>
</div>
<div class="paragraph">
<p>You can access the message history from Java code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;MessageHistory&gt; list = exchange.getProperty(Exchange.MESSAGE_HISTORY, List.class);
for (MessageHistory history : list) {
    System.out.println("Routed at id: " + history.getNode().getId());
}</code></pre>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
